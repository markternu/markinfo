#!/bin/bash

# ============================================================================
# åŠŸèƒ½2ï¼šè¯»å–æ–‡ä»¶æœ«å°¾ V-L-T æ•°æ®å¹¶ç§»é™¤ï¼ˆV-L-Tç‰ˆæœ¬ï¼‰
# å‚æ•°1: æ–‡ä»¶è·¯å¾„
# è¿”å›: 0=æˆåŠŸ, 1=å¤±è´¥
# è¾“å‡º: è¯»å–åˆ°çš„åŸå§‹æ–‡ä»¶åï¼ˆé€šè¿‡ echo åˆ° stdoutï¼‰
# ç‰¹ç‚¹: è¯»å–ååˆ é™¤ V-L-T æ•°æ®ï¼Œæ¢å¤æ–‡ä»¶åŸå§‹çŠ¶æ€
# æ•°æ®ç»“æ„: [Value NB][Length 4B][Type 100B]
# ============================================================================
function read_and_remove_fixed_bytes() {
    local file_path="$1"
    
    # ========================================================================
    # å‚æ•°æ£€æŸ¥
    # ========================================================================
    if [ -z "$file_path" ]; then
        echo "âŒ é”™è¯¯: æ–‡ä»¶è·¯å¾„ä¸èƒ½ä¸ºç©º" >&2
        echo "ç”¨æ³•: read_and_remove_fixed_bytes <æ–‡ä»¶è·¯å¾„>" >&2
        return 1
    fi
    
    # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    if [ ! -f "$file_path" ]; then
        echo "âŒ é”™è¯¯: æ–‡ä»¶ '$file_path' ä¸å­˜åœ¨" >&2
        return 1
    fi
    
    # è·å–æ–‡ä»¶å¤§å°
    local file_size=$(wc -c < "$file_path")
    
    # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦è‡³å°‘æœ‰104å­—èŠ‚ï¼ˆV-L-Tæœ€å°ç»“æ„ï¼šLength(4B) + Type(100B)ï¼‰
    if [ $file_size -lt 104 ]; then
        echo "âŒ é”™è¯¯: æ–‡ä»¶å¤§å°ä¸è¶³104å­—èŠ‚ (å½“å‰: $file_size å­—èŠ‚)" >&2
        echo "   V-L-T æœ€å°ç»“æ„éœ€è¦: Length(4B) + Type(100B) = 104å­—èŠ‚" >&2
        return 1
    fi
    
    echo "ğŸ” å¼€å§‹è¯»å–å¹¶ç§»é™¤æ–‡ä»¶æœ«å°¾ V-L-T æ•°æ®: '$file_path'" >&2
    echo "" >&2
    
    # ========================================================================
    # æ­¥éª¤1ï¼šéªŒè¯ Type å­—æ®µï¼ˆæœ«å°¾100å­—èŠ‚ï¼‰- V-L-T æ ¸å¿ƒä¼˜åŠ¿ï¼
    # ========================================================================
    echo "ğŸ“– [æ­¥éª¤1/4] éªŒè¯ Type å­—æ®µ (æœ«å°¾100å­—èŠ‚)..." >&2
    
    # è¯»å–æ–‡ä»¶æœ«å°¾100å­—èŠ‚
    local mark=$(tail -c 100 "$file_path" 2>/dev/null | tr -d '\0' 2>/dev/null)
    
    if [ -z "$mark" ]; then
        echo "âŒ é”™è¯¯: è¯»å– Type å­—æ®µå¤±è´¥" >&2
        return 1
    fi
    
    echo "   æ£€æµ‹åˆ°çš„æ ‡å¿—ä½: '$mark'" >&2
    echo "   æœŸæœ›çš„æ ‡å¿—ä½: 'FKY996'" >&2
    
    # å¿«é€ŸéªŒè¯ï¼šå¦‚æœä¸æ˜¯ FKY996ï¼Œç«‹å³è¿”å›
    if [ "$mark" != "FKY996" ]; then
        echo "   âŒ æ ‡å¿—ä½ä¸åŒ¹é…" >&2
        echo "" >&2
        echo "âŒ é”™è¯¯: æ–‡ä»¶éé€šè¿‡æœ¬è„šæœ¬è¿½åŠ å†™å…¥ç”Ÿæˆçš„æ–‡ä»¶" >&2
        echo "   æ— æ³•é€šè¿‡æœ¬åŠŸèƒ½è¯»å–å¹¶åˆ‡é™¤æ–‡ä»¶æœ«å°¾æ•°æ®" >&2
        return 1
    fi
    
    echo "   âœ… æ ‡å¿—ä½éªŒè¯é€šè¿‡" >&2
    
    # ========================================================================
    # æ­¥éª¤2ï¼šè¯»å– Length å­—æ®µï¼ˆå€’æ•°101-104å­—èŠ‚ï¼‰
    # ========================================================================
    echo "ğŸ“– [æ­¥éª¤2/4] è¯»å– Length å­—æ®µ..." >&2
    
    # è¯»å–æœ«å°¾104å­—èŠ‚ï¼Œæå–å‰4å­—èŠ‚ä½œä¸º Length
    local length_hex=$(tail -c 104 "$file_path" 2>/dev/null | head -c 4 2>/dev/null | xxd -p 2>/dev/null | tr -d '\n')
    
    if [ -z "$length_hex" ]; then
        echo "âŒ é”™è¯¯: è¯»å– Length å­—æ®µå¤±è´¥" >&2
        return 1
    fi
    
    # å°†åå…­è¿›åˆ¶è½¬æ¢ä¸ºåè¿›åˆ¶
    local name_length=$((16#$length_hex))
    
    echo "   æ–‡ä»¶åé•¿åº¦: $name_length å­—èŠ‚" >&2
    
    # é•¿åº¦åˆç†æ€§æ£€æŸ¥
    local total_vlt_size=$((name_length + 4 + 100))
    
    if [ $name_length -lt 0 ]; then
        echo "âŒ é”™è¯¯: é•¿åº¦å­—æ®µä¸ºè´Ÿæ•° ($name_length)ï¼Œæ•°æ®æŸå" >&2
        return 1
    fi
    
    if [ $file_size -lt $total_vlt_size ]; then
        echo "âŒ é”™è¯¯: é•¿åº¦å­—æ®µå¼‚å¸¸ ($name_length å­—èŠ‚)ï¼Œè¶…è¿‡æ–‡ä»¶å‰©ä½™å¤§å°" >&2
        echo "   æ–‡ä»¶å¤§å°: $file_size å­—èŠ‚" >&2
        echo "   VLTæ€»å¤§å°: $total_vlt_size å­—èŠ‚" >&2
        return 1
    fi
    
    echo "   âœ… é•¿åº¦å­—æ®µæœ‰æ•ˆ" >&2
    
    # ========================================================================
    # æ­¥éª¤3ï¼šè¯»å– Value å­—æ®µï¼ˆåŸå§‹æ–‡ä»¶åï¼‰
    # ========================================================================
    echo "ğŸ“– [æ­¥éª¤3/4] è¯»å– Value å­—æ®µ (åŸå§‹æ–‡ä»¶å)..." >&2
    
    echo "   VLT æ€»å¤§å°: $total_vlt_size å­—èŠ‚" >&2
    echo "   â”œâ”€ Value:  $name_length å­—èŠ‚" >&2
    echo "   â”œâ”€ Length: 4 å­—èŠ‚" >&2
    echo "   â””â”€ Type:   100 å­—èŠ‚" >&2
    
    # è¯»å–å®Œæ•´çš„ V-L-T å—ï¼Œæå–å‰ name_length å­—èŠ‚ï¼ˆValueï¼‰
    local content_string=$(tail -c $total_vlt_size "$file_path" 2>/dev/null | head -c $name_length 2>/dev/null)
    
    if [ -z "$content_string" ]; then
        echo "âŒ é”™è¯¯: è¯»å– Value å­—æ®µå¤±è´¥æˆ–æ–‡ä»¶åä¸ºç©º" >&2
        return 1
    fi
    
    echo "   âœ… æ–‡ä»¶åè¯»å–æˆåŠŸ: '$content_string'" >&2
    
    # ========================================================================
    # æ­¥éª¤4ï¼šåˆ é™¤ V-L-T æ•°æ®ï¼ˆæˆªæ–­æ–‡ä»¶ï¼‰
    # ========================================================================
    echo "ğŸ—‘ï¸  [æ­¥éª¤4/4] ç§»é™¤ V-L-T æ•°æ®..." >&2
    
    # è®¡ç®—æ–°æ–‡ä»¶å¤§å°ï¼ˆç§»é™¤æœ«å°¾ V-L-T æ•°æ®ï¼‰
    local new_size=$((file_size - total_vlt_size))
    
    echo "   æ–‡ä»¶å¤§å°å˜åŒ–:" >&2
    echo "   â”œâ”€ åŸå§‹å¤§å°: $file_size å­—èŠ‚" >&2
    echo "   â”œâ”€ ç§»é™¤æ•°æ®: $total_vlt_size å­—èŠ‚" >&2
    echo "   â””â”€ æ–°å¤§å°:   $new_size å­—èŠ‚" >&2
    
    # æ£€æŸ¥æ–°å¤§å°æ˜¯å¦åˆç†
    if [ $new_size -lt 0 ]; then
        echo "âŒ é”™è¯¯: è®¡ç®—å‡ºçš„æ–°æ–‡ä»¶å¤§å°ä¸ºè´Ÿæ•°ï¼Œæ•°æ®å¼‚å¸¸" >&2
        return 1
    fi
    
    # åˆ›å»ºä¸´æ—¶æ–‡ä»¶
    local new_temp_file=$(mktemp)
    
    if [ -z "$new_temp_file" ] || [ ! -f "$new_temp_file" ]; then
        echo "âŒ é”™è¯¯: æ— æ³•åˆ›å»ºä¸´æ—¶æ–‡ä»¶" >&2
        return 1
    fi
    
    # å°†åŸæ–‡ä»¶é™¤äº†æœ«å°¾ V-L-T æ•°æ®çš„éƒ¨åˆ†å¤åˆ¶åˆ°ä¸´æ—¶æ–‡ä»¶
    if ! head -c $new_size "$file_path" > "$new_temp_file" 2>/dev/null; then
        echo "âŒ é”™è¯¯: å¤åˆ¶æ–‡ä»¶å†…å®¹å¤±è´¥" >&2
        rm -f "$new_temp_file"
        return 1
    fi
    
    # ç”¨ä¸´æ—¶æ–‡ä»¶æ›¿æ¢åŸæ–‡ä»¶
    if ! mv "$new_temp_file" "$file_path" 2>/dev/null; then
        echo "âŒ é”™è¯¯: æ›¿æ¢æ–‡ä»¶å¤±è´¥" >&2
        rm -f "$new_temp_file"
        return 1
    fi
    
    echo "   âœ… V-L-T æ•°æ®å·²æˆåŠŸç§»é™¤" >&2
    
    # ========================================================================
    # å®Œæˆè¾“å‡º
    # ========================================================================
    echo "" >&2
    echo "ğŸ‰ V-L-T æ•°æ®è¯»å–å¹¶ç§»é™¤å®Œæˆ!" >&2
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2
    echo "ğŸ“Š å¤„ç†ç»“æœ:" >&2
    echo "   â”œâ”€ æ ‡å¿—ä½éªŒè¯: '$mark' âœ…" >&2
    echo "   â”œâ”€ è¯»å–æ–‡ä»¶å: '$content_string'" >&2
    echo "   â”œâ”€ ç§»é™¤å­—èŠ‚æ•°: $total_vlt_size å­—èŠ‚" >&2
    echo "   â”œâ”€ æ–‡ä»¶æ–°å¤§å°: $(wc -c < "$file_path") å­—èŠ‚" >&2
    echo "   â””â”€ æ•°æ®ç»“æ„:   Value(${name_length}B) + Length(4B) + Type(100B)" >&2
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2
    echo "" >&2
    
    # å°†è¯»å–åˆ°çš„æ–‡ä»¶åå†…å®¹è¾“å‡ºåˆ° stdoutï¼ˆä¾›è°ƒç”¨è€…è·å–ï¼‰
    echo "$content_string"
    return 0
}


# ============================================================================
# ä½¿ç”¨ç¤ºä¾‹
# ============================================================================
# # ç¤ºä¾‹1ï¼šè¯»å–å¹¶ç§»é™¤ï¼Œç„¶åé‡å‘½åæ–‡ä»¶
# original_name=$(read_and_remove_fixed_bytes "/path/to/file")
# if [ $? -eq 0 ]; then
#     mv "/path/to/file" "/path/to/$original_name"
# fi
#
# # ç¤ºä¾‹2ï¼šä»…è¯»å–å’Œç§»é™¤ï¼Œä¸é‡å‘½å
# read_and_remove_fixed_bytes "/path/to/file"
