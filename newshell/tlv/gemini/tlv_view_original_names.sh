#!/bin/bash

# ============================================================================
# åŠŸèƒ½9ï¼šæŸ¥çœ‹æ–‡ä»¶æœ«å°¾ V-L-T æ•°æ®çš„åŸå§‹æ–‡ä»¶åï¼ˆV-L-Tç‰ˆæœ¬ï¼‰
# å‚æ•°1: æ–‡ä»¶è·¯å¾„
# è¿”å›: 0=æˆåŠŸ, 1=å¤±è´¥
# è¾“å‡º: è¯»å–åˆ°çš„åŸå§‹æ–‡ä»¶åï¼ˆé€šè¿‡ echoï¼‰
# ç‰¹ç‚¹: åªè¯»å–ï¼Œä¸ä¿®æ”¹æ–‡ä»¶
# æ•°æ®ç»“æ„: [Value NB][Length 4B][Type 100B]
# ============================================================================
function view_original_names() {
    local file_path="$1"
    
    # ========================================================================
    # å‚æ•°æ£€æŸ¥
    # ========================================================================
    if [ -z "$file_path" ]; then
        echo "âŒ é”™è¯¯: æ–‡ä»¶è·¯å¾„ä¸èƒ½ä¸ºç©º" >&2
        echo "ç”¨æ³•: view_original_names <æ–‡ä»¶è·¯å¾„>" >&2
        return 1
    fi
    
    # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    if [ ! -f "$file_path" ]; then
        echo "âŒ é”™è¯¯: æ–‡ä»¶ '$file_path' ä¸å­˜åœ¨" >&2
        return 1
    fi
    
    # è·å–æ–‡ä»¶å¤§å°
    local file_size=$(wc -c < "$file_path")
    
    # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦è‡³å°‘æœ‰104å­—èŠ‚ï¼ˆV-L-Tæœ€å°ç»“æ„ï¼šLength(4B) + Type(100B)ï¼‰
    if [ $file_size -lt 104 ]; then
        echo "âŒ é”™è¯¯: æ–‡ä»¶å¤§å°ä¸è¶³104å­—èŠ‚ (å½“å‰: $file_size å­—èŠ‚)" >&2
        echo "   V-L-T æœ€å°ç»“æ„éœ€è¦: Length(4B) + Type(100B) = 104å­—èŠ‚" >&2
        return 1
    fi
    
    echo "ğŸ” å¼€å§‹æŸ¥çœ‹æ–‡ä»¶æœ«å°¾çš„åŸå§‹æ–‡ä»¶åä¿¡æ¯" >&2
    echo "ğŸ“‚ æ–‡ä»¶è·¯å¾„: '$file_path'" >&2
    echo "ğŸ“ æ–‡ä»¶å¤§å°: $file_size å­—èŠ‚" >&2
    echo "" >&2
    
    # ========================================================================
    # æ­¥éª¤1ï¼šéªŒè¯ Type å­—æ®µï¼ˆæœ«å°¾100å­—èŠ‚ï¼‰- V-L-T æ ¸å¿ƒä¼˜åŠ¿ï¼
    # ========================================================================
    echo "ğŸ“– [æ­¥éª¤1/3] éªŒè¯ Type å­—æ®µ (æœ«å°¾100å­—èŠ‚)..." >&2
    
    # è¯»å–æ–‡ä»¶æœ«å°¾100å­—èŠ‚
    local mark=$(tail -c 100 "$file_path" 2>/dev/null | tr -d '\0' 2>/dev/null)
    
    if [ -z "$mark" ]; then
        echo "âŒ é”™è¯¯: è¯»å– Type å­—æ®µå¤±è´¥" >&2
        return 1
    fi
    
    echo "   æ£€æµ‹åˆ°çš„æ ‡å¿—ä½: '$mark'" >&2
    echo "   æœŸæœ›çš„æ ‡å¿—ä½: 'FKY996'" >&2
    
    # å¿«é€ŸéªŒè¯ï¼šå¦‚æœä¸æ˜¯ FKY996ï¼Œç«‹å³è¿”å›
    if [ "$mark" != "FKY996" ]; then
        echo "   âŒ æ ‡å¿—ä½ä¸åŒ¹é… (æ£€æµ‹åˆ°: '$mark'ï¼ŒæœŸæœ›: 'FKY996')" >&2
        echo "" >&2
        echo "âŒ é”™è¯¯: æ–‡ä»¶éé€šè¿‡æœ¬è„šæœ¬è¿½åŠ å†™å…¥ç”Ÿæˆçš„æ–‡ä»¶" >&2
        echo "   æ— æ³•è¯»å–æœ«å°¾çš„ V-L-T æ•°æ®" >&2
        return 1
    fi
    
    echo "   âœ… æ ‡å¿—ä½éªŒè¯é€šè¿‡" >&2
    
    # ========================================================================
    # æ­¥éª¤2ï¼šè¯»å– Length å­—æ®µï¼ˆå€’æ•°101-104å­—èŠ‚ï¼‰
    # ========================================================================
    echo "ğŸ“– [æ­¥éª¤2/3] è¯»å– Length å­—æ®µ..." >&2
    
    # è¯»å–æœ«å°¾104å­—èŠ‚ï¼Œæå–å‰4å­—èŠ‚ä½œä¸º Length
    local length_hex=$(tail -c 104 "$file_path" 2>/dev/null | head -c 4 2>/dev/null | xxd -p 2>/dev/null | tr -d '\n')
    
    if [ -z "$length_hex" ]; then
        echo "âŒ é”™è¯¯: è¯»å– Length å­—æ®µå¤±è´¥" >&2
        return 1
    fi
    
    # å°†åå…­è¿›åˆ¶è½¬æ¢ä¸ºåè¿›åˆ¶
    local name_length=$((16#$length_hex))
    
    echo "   æ–‡ä»¶åé•¿åº¦: $name_length å­—èŠ‚" >&2
    
    # é•¿åº¦åˆç†æ€§æ£€æŸ¥
    local total_vlt_size=$((name_length + 4 + 100))
    
    if [ $name_length -lt 0 ]; then
        echo "âŒ é”™è¯¯: é•¿åº¦å­—æ®µä¸ºè´Ÿæ•° ($name_length)ï¼Œæ•°æ®æŸå" >&2
        return 1
    fi
    
    if [ $file_size -lt $total_vlt_size ]; then
        echo "âŒ é”™è¯¯: é•¿åº¦å­—æ®µå¼‚å¸¸ ($name_length å­—èŠ‚)ï¼Œè¶…è¿‡æ–‡ä»¶å‰©ä½™å¤§å°" >&2
        echo "   æ–‡ä»¶å¤§å°: $file_size å­—èŠ‚" >&2
        echo "   VLTæ€»å¤§å°: $total_vlt_size å­—èŠ‚" >&2
        echo "   å‰©ä½™ç©ºé—´: $((file_size - 104)) å­—èŠ‚" >&2
        return 1
    fi
    
    echo "   âœ… é•¿åº¦å­—æ®µæœ‰æ•ˆ" >&2
    
    # ========================================================================
    # æ­¥éª¤3ï¼šè¯»å– Value å­—æ®µï¼ˆåŸå§‹æ–‡ä»¶åï¼‰
    # ========================================================================
    echo "ğŸ“– [æ­¥éª¤3/3] è¯»å– Value å­—æ®µ (åŸå§‹æ–‡ä»¶å)..." >&2
    
    echo "   VLT æ€»å¤§å°: $total_vlt_size å­—èŠ‚" >&2
    echo "   â”œâ”€ Value:  $name_length å­—èŠ‚" >&2
    echo "   â”œâ”€ Length: 4 å­—èŠ‚" >&2
    echo "   â””â”€ Type:   100 å­—èŠ‚" >&2
    
    # è¯»å–å®Œæ•´çš„ V-L-T å—ï¼Œæå–å‰ name_length å­—èŠ‚ï¼ˆValueï¼‰
    local content_string=$(tail -c $total_vlt_size "$file_path" 2>/dev/null | head -c $name_length 2>/dev/null)
    
    if [ -z "$content_string" ]; then
        echo "âŒ é”™è¯¯: è¯»å– Value å­—æ®µå¤±è´¥æˆ–æ–‡ä»¶åä¸ºç©º" >&2
        return 1
    fi
    
    echo "   âœ… æ–‡ä»¶åè¯»å–æˆåŠŸ" >&2
    
    # ========================================================================
    # è¾“å‡ºç»“æœ
    # ========================================================================
    echo "" >&2
    echo "ğŸ‰ V-L-T æ•°æ®è¯»å–å®Œæˆ!" >&2
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2
    echo "ğŸ“‹ è¯»å–ç»“æœ:" >&2
    echo "   â”œâ”€ [Type]   æ ‡å¿—ä½: '$mark' âœ…" >&2
    echo "   â”œâ”€ [Length] æ–‡ä»¶åé•¿åº¦: $name_length å­—èŠ‚" >&2
    echo "   â””â”€ [Value]  åŸå§‹æ–‡ä»¶å: '$content_string'" >&2
    echo "" >&2
    echo "ğŸ“Š æ•°æ®ç»“æ„: Value(${name_length}B) + Length(4B) + Type(100B)" >&2
    echo "âš ï¸  æ³¨æ„: æœ¬æ“ä½œä»…æŸ¥çœ‹ï¼Œæœªä¿®æ”¹æ–‡ä»¶" >&2
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2
    echo "" >&2
    
    # å°†è¯»å–åˆ°çš„åŸå§‹æ–‡ä»¶åè¾“å‡ºåˆ° stdoutï¼ˆä¾›è°ƒç”¨è€…è·å–ï¼‰
    echo "$content_string"
    return 0
}


# ============================================================================
# ä½¿ç”¨ç¤ºä¾‹
# ============================================================================
# view_original_names "/path/to/file"
#
# æˆ–è€…æ•è·è¿”å›å€¼ï¼š
# original_name=$(view_original_names "/path/to/file")
# if [ $? -eq 0 ]; then
#     echo "åŸå§‹æ–‡ä»¶å: $original_name"
# fi
