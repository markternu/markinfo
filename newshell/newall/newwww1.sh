#!/bin/bash

# ============================================================================
# TLV æ•°æ®ç»“æ„æ–¹æ¡ˆ (Type-Length-Value) - ä¿®å¤ç‰ˆ
# ============================================================================
# å­˜å‚¨ç»“æ„ï¼ˆä»æ–‡ä»¶æœ«å°¾å¾€å‰ï¼‰ï¼š
#   [åŸå§‹æ–‡ä»¶å†…å®¹] [Type: 100B] [Length: 4B] [Value: NB]
#                                              â†‘
#                                          æ–‡ä»¶æœ«å°¾
# è¯»å–é¡ºåºï¼š
#   1. ä»æ–‡ä»¶æœ«å°¾è¯»å– Value
#   2. å¾€å‰è¯»å– Length (4å­—èŠ‚)
#   3. å†å¾€å‰è¯»å– Type (100å­—èŠ‚)
# ============================================================================

# åŠŸèƒ½1ï¼šå‘æ–‡ä»¶æœ«å°¾è¿½åŠ  TLV æ ¼å¼æ•°æ®
# å‚æ•°1: è¦å†™å…¥çš„å­—ç¬¦ä¸²ï¼ˆæ–‡ä»¶åï¼‰
# å‚æ•°2: ç›®æ ‡æ–‡ä»¶è·¯å¾„
# è¿”å›: 0=æˆåŠŸ, 1=å¤±è´¥
function write_fixed_bytes() {
    local name="$1"
    local file_path="$2"
    
    # å‚æ•°æ£€æŸ¥
    if [ -z "$name" ] || [ -z "$file_path" ]; then
        echo "âŒ é”™è¯¯: å‚æ•°ä¸èƒ½ä¸ºç©º" >&2
        echo "ç”¨æ³•: write_fixed_bytes <å­—ç¬¦ä¸²> <æ–‡ä»¶è·¯å¾„>" >&2
        return 1
    fi
    
    # æ–‡ä»¶å­˜åœ¨æ€§æ£€æŸ¥
    if [ ! -f "$file_path" ]; then
        echo "âŒ é”™è¯¯: æ–‡ä»¶ä¸å­˜åœ¨: '$file_path'" >&2
        return 1
    fi
    
    # æ ‡å¿—å­—ç¬¦ä¸²
    local mark_string="FKY996"
    
    echo "ğŸ”§ å¼€å§‹å†™å…¥ TLV æ•°æ®åˆ°æ–‡ä»¶: '$file_path'"
    
    # ========================================================================
    # ç¬¬ä¸€æ­¥ï¼šå†™å…¥ Type å­—æ®µï¼ˆ100å­—èŠ‚æ ‡å¿—ä½ï¼‰
    # ========================================================================
    echo "ğŸ“ [Type] å†™å…¥100å­—èŠ‚æ ‡å¿—ä½ '$mark_string'"
    
    local mark_size=$(printf "%s" "$mark_string" | wc -c)
    local mark_padding_size=$((100 - mark_size))
    
    if [ $mark_padding_size -lt 0 ]; then
        echo "   âš ï¸  è­¦å‘Š: æ ‡å¿—å­—ç¬¦ä¸²è¶…è¿‡100å­—èŠ‚ï¼Œå°†è¢«æˆªæ–­" >&2
        printf "%s" "$mark_string" | dd bs=1 count=100 >> "$file_path" 2>/dev/null
    else
        # å†™å…¥æ ‡å¿—å­—ç¬¦ä¸²
        printf "%s" "$mark_string" >> "$file_path"
        # å¡«å……å‰©ä½™å­—èŠ‚ä¸º null
        dd if=/dev/zero bs=1 count=$mark_padding_size >> "$file_path" 2>/dev/null
    fi
    
    echo "   âœ… Type å­—æ®µå†™å…¥å®Œæˆ (100å­—èŠ‚)"
    
    # ========================================================================
    # ç¬¬äºŒæ­¥ï¼šå†™å…¥ Length å­—æ®µï¼ˆ4å­—èŠ‚é•¿åº¦ä¿¡æ¯ï¼‰
    # ========================================================================
    echo "ğŸ“ [Length] å†™å…¥æ–‡ä»¶åé•¿åº¦å­—æ®µ (4å­—èŠ‚)"
    
    # è®¡ç®—æ–‡ä»¶åçš„å®é™…å­—èŠ‚æ•°ï¼ˆUTF-8 ç¼–ç ï¼‰
    local name_size=$(printf "%s" "$name" | wc -c)
    echo "   æ–‡ä»¶åå®é™…å­—èŠ‚æ•°: $name_size å­—èŠ‚"
    
    # æ£€æŸ¥é•¿åº¦æ˜¯å¦è¶…è¿‡32ä½æ— ç¬¦å·æ•´æ•°æœ€å¤§å€¼ï¼ˆ4294967295ï¼‰
    if [ $name_size -gt 4294967295 ]; then
        echo "âŒ é”™è¯¯: æ–‡ä»¶åè¿‡é•¿ ($name_size å­—èŠ‚)ï¼Œè¶…è¿‡4GBé™åˆ¶" >&2
        return 1
    fi
    
    # å°†é•¿åº¦è½¬æ¢ä¸º4å­—èŠ‚å¤§ç«¯åºï¼ˆBig-Endianï¼‰æ•´æ•°
    # æ ¼å¼ï¼š32ä½æ— ç¬¦å·æ•´æ•°ï¼Œé«˜å­—èŠ‚åœ¨å‰
    printf "%08x" "$name_size" | xxd -r -p >> "$file_path"
    
    echo "   âœ… Length å­—æ®µå†™å…¥å®Œæˆ (4å­—èŠ‚, å€¼=$name_size)"
    
    # ========================================================================
    # ç¬¬ä¸‰æ­¥ï¼šå†™å…¥ Value å­—æ®µï¼ˆæ–‡ä»¶ååŸå§‹å†…å®¹ï¼‰
    # ========================================================================
    echo "ğŸ“ [Value] å†™å…¥æ–‡ä»¶åå†…å®¹ ($name_size å­—èŠ‚)"
    
    # ç›´æ¥å†™å…¥æ–‡ä»¶åï¼Œä¿ç•™åŸå§‹ UTF-8 ç¼–ç ï¼Œä¸åšä»»ä½•è½¬æ¢
    printf "%s" "$name" >> "$file_path"
    
    echo "   âœ… Value å­—æ®µå†™å…¥å®Œæˆ"
    
    # ========================================================================
    # å®Œæˆç»Ÿè®¡
    # ========================================================================
    local total_bytes=$((100 + 4 + name_size))
    
    echo ""
    echo "ğŸ‰ TLV æ•°æ®å†™å…¥å®Œæˆ!"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ“Š å†™å…¥ç»Ÿè®¡:"
    echo "   â”œâ”€ [Type]   æ ‡å¿—ä½: 100 å­—èŠ‚ (å›ºå®š)"
    echo "   â”œâ”€ [Length] é•¿åº¦å­—æ®µ: 4 å­—èŠ‚ (å€¼=$name_size)"
    echo "   â””â”€ [Value]  æ–‡ä»¶å: $name_size å­—èŠ‚ (UTF-8)"
    echo "   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    echo "   æ€»è®¡å†™å…¥: $total_bytes å­—èŠ‚"
    echo ""
    echo "ğŸ“ æ–‡ä»¶åé¢„è§ˆ: '${name:0:50}$([ ${#name} -gt 50 ] && echo "...")'"
    echo "ğŸ“Š æ–‡ä»¶å½“å‰å¤§å°: $(wc -c < "$file_path") å­—èŠ‚"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    return 0
}


# ============================================================================
# åŠŸèƒ½2ï¼šä»æ–‡ä»¶æœ«å°¾è¯»å– TLV æ ¼å¼æ•°æ®ï¼ˆä¿®å¤ç‰ˆï¼‰
# å‚æ•°1: æ–‡ä»¶è·¯å¾„
# è¿”å›: 0=æˆåŠŸ, 1=å¤±è´¥
# è¾“å‡º: è¯»å–åˆ°çš„æ–‡ä»¶åï¼ˆé€šè¿‡ echoï¼‰
# ============================================================================
function read_fixed_bytes() {
    local file_path="$1"
    
    # å‚æ•°æ£€æŸ¥
    if [ -z "$file_path" ]; then
        echo "âŒ é”™è¯¯: æ–‡ä»¶è·¯å¾„ä¸èƒ½ä¸ºç©º" >&2
        return 1
    fi
    
    # æ–‡ä»¶å­˜åœ¨æ€§æ£€æŸ¥
    if [ ! -f "$file_path" ]; then
        echo "âŒ é”™è¯¯: æ–‡ä»¶ä¸å­˜åœ¨: '$file_path'" >&2
        return 1
    fi
    
    local file_size=$(wc -c < "$file_path")
    
    # æœ€å°æ–‡ä»¶å¤§å°æ£€æŸ¥ï¼ˆè‡³å°‘éœ€è¦ Type + Length = 104 å­—èŠ‚ï¼‰
    if [ $file_size -lt 104 ]; then
        echo "âŒ é”™è¯¯: æ–‡ä»¶å¤ªå° ($file_size å­—èŠ‚)ï¼Œæ— æ³•åŒ…å«å®Œæ•´ TLV æ•°æ®" >&2
        return 1
    fi
    
    echo "ğŸ” å¼€å§‹è¯»å–æ–‡ä»¶æœ«å°¾ TLV æ•°æ®: '$file_path'" >&2
    echo "" >&2
    
    # ========================================================================
    # ç¬¬ä¸€æ­¥ï¼šè¯»å– Length å­—æ®µï¼ˆå€’æ•°ç¬¬4å­—èŠ‚ä¹‹å‰çš„4å­—èŠ‚ï¼‰
    # ========================================================================
    echo "ğŸ“– [Length] è¯»å–é•¿åº¦å­—æ®µ..." >&2
    
    # å…ˆè¯»å–æ–‡ä»¶æœ«å°¾104å­—èŠ‚çš„æ•°æ®å—ï¼ˆåŒ…å«å®Œæ•´çš„ Type + Length + éƒ¨åˆ†Valueï¼‰
    local tail_block=$(tail -c 104 "$file_path" | head -c 104)
    
    # ä»è¿™104å­—èŠ‚ä¸­æå– Length å­—æ®µï¼ˆç¬¬101-104å­—èŠ‚ï¼‰
    local length_hex=$(printf "%s" "$tail_block" | tail -c 4 | xxd -p)
    local name_length=$((16#$length_hex))
    
    echo "   æ–‡ä»¶åé•¿åº¦: $name_length å­—èŠ‚" >&2
    
    # é•¿åº¦åˆç†æ€§æ£€æŸ¥
    if [ $name_length -lt 0 ] || [ $name_length -gt $((file_size - 104)) ]; then
        echo "âŒ é”™è¯¯: é•¿åº¦å­—æ®µå¼‚å¸¸ ($name_length å­—èŠ‚)ï¼Œå¯èƒ½æ•°æ®æŸå" >&2
        return 1
    fi
    
    echo "   âœ… é•¿åº¦å­—æ®µè¯»å–æˆåŠŸ" >&2
    
    # ========================================================================
    # ç¬¬äºŒæ­¥ï¼šè¯»å– Type å­—æ®µï¼ˆæ ‡å¿—ä½éªŒè¯ï¼‰
    # ========================================================================
    echo "ğŸ“– [Type] è¯»å–å¹¶éªŒè¯æ ‡å¿—ä½..." >&2
    
    # ä» tail_block ä¸­æå–å‰100å­—èŠ‚ä½œä¸º Type å­—æ®µ
    local mark=$(printf "%s" "$tail_block" | head -c 100 | tr -d '\0')
    
    echo "   æ ‡å¿—ä½å†…å®¹: '$mark'" >&2
    
    if [ "$mark" != "FKY996" ]; then
        echo "âŒ é”™è¯¯: æ ‡å¿—ä½ä¸åŒ¹é… (æœŸæœ›='FKY996', å®é™…='$mark')" >&2
        echo "   æ–‡ä»¶å¯èƒ½æœªç»å¤„ç†æˆ–æ•°æ®å·²æŸå" >&2
        return 1
    fi
    
    echo "   âœ… æ ‡å¿—ä½éªŒè¯é€šè¿‡" >&2
    
    # ========================================================================
    # ç¬¬ä¸‰æ­¥ï¼šè¯»å– Value å­—æ®µï¼ˆæ–‡ä»¶åå†…å®¹ï¼‰
    # ========================================================================
    echo "ğŸ“– [Value] è¯»å–æ–‡ä»¶åå†…å®¹ ($name_length å­—èŠ‚)..." >&2
    
    # è¯»å–å®Œæ•´çš„ TLV å—ï¼ˆType + Length + Valueï¼‰
    local total_tlv_size=$((100 + 4 + name_length))
    local full_tlv=$(tail -c $total_tlv_size "$file_path")
    
    # ä»å®Œæ•´å—ä¸­æå– Valueï¼ˆè·³è¿‡å‰104å­—èŠ‚çš„ Type + Lengthï¼‰
    local file_name=$(printf "%s" "$full_tlv" | tail -c +105)
    
    echo "   âœ… æ–‡ä»¶åè¯»å–æˆåŠŸ" >&2
    echo "" >&2
    
    # ========================================================================
    # è¾“å‡ºç»“æœ
    # ========================================================================
    echo "ğŸ‰ TLV æ•°æ®è¯»å–å®Œæˆ!" >&2
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2
    echo "ğŸ“Š è¯»å–ç»“æœ:" >&2
    echo "   â”œâ”€ [Type]   æ ‡å¿—ä½: FKY996 âœ…" >&2
    echo "   â”œâ”€ [Length] æ–‡ä»¶åé•¿åº¦: $name_length å­—èŠ‚" >&2
    echo "   â””â”€ [Value]  æ–‡ä»¶åå†…å®¹: '$file_name'" >&2
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2
    
    # å°†æ–‡ä»¶åè¾“å‡ºåˆ° stdoutï¼ˆä¾›è°ƒç”¨è€…è·å–ï¼‰
    echo "$file_name"
    
    return 0
}


# ============================================================================
# åŠŸèƒ½3ï¼šéªŒè¯æ–‡ä»¶æ˜¯å¦åŒ…å«æœ‰æ•ˆçš„ TLV æ•°æ®ï¼ˆä¿®å¤ç‰ˆï¼‰
# å‚æ•°1: æ–‡ä»¶è·¯å¾„
# è¿”å›: 0=åŒ…å«æœ‰æ•ˆTLVæ•°æ®, 1=ä¸åŒ…å«æˆ–æ•°æ®æ— æ•ˆ
# ============================================================================
function verify_tlv_data() {
    local file_path="$1"
    
    if [ -z "$file_path" ] || [ ! -f "$file_path" ]; then
        return 1
    fi
    
    local file_size=$(wc -c < "$file_path")
    
    # æ–‡ä»¶å¤ªå°ï¼Œæ— æ³•åŒ…å« TLV æ•°æ®
    if [ $file_size -lt 104 ]; then
        return 1
    fi
    
    # è¯»å–æ–‡ä»¶æœ«å°¾104å­—èŠ‚
    local tail_block=$(tail -c 104 "$file_path" | head -c 100)
    
    # æå–æ ‡å¿—ä½ï¼ˆå‰100å­—èŠ‚ï¼‰
    local mark=$(printf "%s" "$tail_block" | tr -d '\0')
    
    # éªŒè¯æ ‡å¿—ä½
    if [ "$mark" = "FKY996" ]; then
        return 0  # åŒ…å«æœ‰æ•ˆ TLV æ•°æ®
    else
        return 1  # ä¸åŒ…å«æœ‰æ•ˆ TLV æ•°æ®
    fi
}


# ============================================================================
# åŠŸèƒ½4ï¼šç§»é™¤æ–‡ä»¶æœ«å°¾çš„ TLV æ•°æ®ï¼ˆä¿®å¤ç‰ˆï¼‰
# å‚æ•°1: æ–‡ä»¶è·¯å¾„
# è¿”å›: 0=æˆåŠŸ, 1=å¤±è´¥
# ============================================================================
function remove_tlv_data() {
    local file_path="$1"
    
    if [ -z "$file_path" ]; then
        echo "âŒ é”™è¯¯: æ–‡ä»¶è·¯å¾„ä¸èƒ½ä¸ºç©º" >&2
        return 1
    fi
    
    if [ ! -f "$file_path" ]; then
        echo "âŒ é”™è¯¯: æ–‡ä»¶ä¸å­˜åœ¨: '$file_path'" >&2
        return 1
    fi
    
    local file_size=$(wc -c < "$file_path")
    
    if [ $file_size -lt 104 ]; then
        echo "âŒ é”™è¯¯: æ–‡ä»¶å¤ªå°ï¼Œæ—  TLV æ•°æ®" >&2
        return 1
    fi
    
    # å…ˆéªŒè¯æ˜¯å¦åŒ…å« TLV æ•°æ®
    if ! verify_tlv_data "$file_path"; then
        echo "âŒ é”™è¯¯: æ–‡ä»¶ä¸åŒ…å«æœ‰æ•ˆçš„ TLV æ•°æ®" >&2
        return 1
    fi
    
    echo "ğŸ—‘ï¸  æ­£åœ¨ç§»é™¤ TLV æ•°æ®..."
    
    # è¯»å– Length å­—æ®µ
    local tail_block=$(tail -c 104 "$file_path")
    local length_hex=$(printf "%s" "$tail_block" | tail -c 4 | xxd -p)
    local name_length=$((16#$length_hex))
    
    # è®¡ç®—éœ€è¦åˆ é™¤çš„æ€»å­—èŠ‚æ•°
    local tlv_total_size=$((100 + 4 + name_length))
    
    # è®¡ç®—åŸå§‹æ–‡ä»¶å¤§å°
    local original_size=$((file_size - tlv_total_size))
    
    echo "   TLV æ•°æ®å¤§å°: $tlv_total_size å­—èŠ‚"
    echo "   åŸå§‹æ–‡ä»¶å¤§å°: $original_size å­—èŠ‚"
    
    # ä½¿ç”¨ truncate æˆªæ–­æ–‡ä»¶
    truncate -s $original_size "$file_path"
    
    echo "âœ… TLV æ•°æ®å·²ç§»é™¤ï¼Œæ–‡ä»¶å·²æ¢å¤"
    
    return 0
}


# ============================================================================
# åŠŸèƒ½5ï¼šæ‰¹é‡éªŒè¯å’Œä¿®å¤ï¼ˆå¯é€‰çš„è¾…åŠ©å‡½æ•°ï¼‰
# å‚æ•°1: æ–‡ä»¶è·¯å¾„
# è¿”å›: æ‰“å° TLV ä¿¡æ¯æ‘˜è¦
# ============================================================================
function inspect_tlv_data() {
    local file_path="$1"
    
    if [ -z "$file_path" ] || [ ! -f "$file_path" ]; then
        echo "âŒ æ–‡ä»¶ä¸å­˜åœ¨"
        return 1
    fi
    
    echo "ğŸ” æ£€æŸ¥æ–‡ä»¶: $file_path"
    
    if verify_tlv_data "$file_path"; then
        echo "   âœ… åŒ…å«æœ‰æ•ˆ TLV æ ‡è®°"
        
        # è¯»å–è¯¦ç»†ä¿¡æ¯
        local file_size=$(wc -c < "$file_path")
        local tail_block=$(tail -c 104 "$file_path")
        local length_hex=$(printf "%s" "$tail_block" | tail -c 4 | xxd -p)
        local name_length=$((16#$length_hex))
        local tlv_size=$((100 + 4 + name_length))
        
        echo "   ğŸ“Š TLV å¤§å°: $tlv_size å­—èŠ‚"
        echo "   ğŸ“Š åŸå§‹æ–‡ä»¶: $((file_size - tlv_size)) å­—èŠ‚"
        echo "   ğŸ“ æ–‡ä»¶åé•¿åº¦: $name_length å­—èŠ‚"
    else
        echo "   âš ï¸  æœªæ‰¾åˆ° TLV æ ‡è®°"
    fi
}


# ============================================================================
# ä½¿ç”¨ç¤ºä¾‹
# ============================================================================
if [ "${BASH_SOURCE[0]}" = "${0}" ]; then
    echo "ğŸ“š TLV å·¥å…·å‡½æ•°åº“å·²åŠ è½½"
    echo ""
    echo "å¯ç”¨å‡½æ•°:"
    echo "  1. write_fixed_bytes <æ–‡ä»¶å> <æ–‡ä»¶è·¯å¾„>  - å†™å…¥ TLV æ•°æ®"
    echo "  2. read_fixed_bytes <æ–‡ä»¶è·¯å¾„>           - è¯»å– TLV æ•°æ®"
    echo "  3. verify_tlv_data <æ–‡ä»¶è·¯å¾„>            - éªŒè¯ TLV æ•°æ®"
    echo "  4. remove_tlv_data <æ–‡ä»¶è·¯å¾„>            - ç§»é™¤ TLV æ•°æ®"
    echo "  5. inspect_tlv_data <æ–‡ä»¶è·¯å¾„>           - æ£€æŸ¥ TLV ä¿¡æ¯"
fi
